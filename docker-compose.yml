version: "3.9"

services:
  gluetun:
    image: qmcgaw/gluetun:v3
    container_name: protonvpn-gateway
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    restart: unless-stopped

    networks:
      vpnnet:
        ipv4_address: 172.30.0.2

    environment:
      - TZ=Europe/London

      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${PROTON_OPENVPN_USER}
      - OPENVPN_PASSWORD=${PROTON_OPENVPN_PASSWORD}

      - SERVER_COUNTRIES=${PROTON_SERVER_COUNTRIES:-United Kingdom}
      - SERVER_CITIES=${PROTON_SERVER_CITIES:-}

      # Optional: Gluetun firewall/kill-switch
      - FIREWALL=on

    volumes:
      - gluetun-state:/gluetun

  netsetup:
    image: alpine:3.20
    container_name: tailscale-vpn-policy-routing
    network_mode: host
    restart: unless-stopped
    privileged: true
    depends_on:
      - gluetun
    command: >
      sh -euxc '
        apk add --no-cache iptables iproute2;

        # Exit-node forwarding
        sysctl -w net.ipv4.ip_forward=1;

        # Wait for tailscale0 (provided by host tailscaled)
        for i in $(seq 1 60); do ip link show tailscale0 && break || sleep 1; done;

        # Mark packets arriving from tailnet that are NOT destined to tailnet
        # (i.e. typical exit-node internet traffic keeps its original public dst)
        iptables -t mangle -C PREROUTING -i tailscale0 ! -d 100.64.0.0/10 -j MARK --set-mark 0x1 2>/dev/null ||
          iptables -t mangle -A PREROUTING -i tailscale0 ! -d 100.64.0.0/10 -j MARK --set-mark 0x1;

        # Allow forwarding from tailnet -> vpn bridge
        iptables -C FORWARD -i tailscale0 -o br-vpnnet -j ACCEPT 2>/dev/null ||
          iptables -A FORWARD -i tailscale0 -o br-vpnnet -j ACCEPT;

        iptables -C FORWARD -i br-vpnnet -o tailscale0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT 2>/dev/null ||
          iptables -A FORWARD -i br-vpnnet -o tailscale0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT;

        # Policy routing: send marked packets to Gluetun gateway
        ip rule show | grep -q "fwmark 0x1.*lookup 100" ||
          ip rule add fwmark 0x1 table 100 priority 10000;

        ip route replace default via 172.30.0.2 dev br-vpnnet table 100;

        tail -f /dev/null
      '

networks:
  vpnnet:
    driver: bridge
    name: vpnnet
    driver_opts:
      com.docker.network.bridge.name: br-vpnnet
    ipam:
      config:
        - subnet: 172.30.0.0/24

volumes:
  gluetun-state:
